var O=0,j=5,J=10,Y=12,Z=14,h=21,Q=25,x=27,R=100,H=101,$=3850,V=522,M=1,d=2,K=4,nn=8,tn=256,rn=2048,en=16384,sn=524288,cn=0,on=1,an=2,un=3,fn=4,_n=512,ln=1024,wn=2048,bn=16384,P=1,U=2,B=3,k=4,C=5,D=0x7fffffffffffffffn,F=-0x8000000000000000n,g=class extends Error{constructor(c,e){super(c),this.code=e}},v=!0;function z(c){const e={},b=c._getSqliteFree(),p=c._malloc(8),f=[p,p+4];function E(n){if(typeof n!="string")return 0;const r=c.lengthBytesUTF8(n),t=c._sqlite3_malloc(r+1);return c.stringToUTF8(n,t,r+1),t}function I(n,r){return BigInt(r)<<32n|BigInt(n)&0xffffffffn}const q=function(){const n=BigInt(Number.MAX_SAFE_INTEGER)>>32n,r=BigInt(Number.MIN_SAFE_INTEGER)>>32n;return function(t,s){return s>n||s<r?I(t,s):s*4294967296+(t&2147483647)-(t&2147483648)}}(),L=new Set;function y(n){if(!L.has(n))throw new g("not a database",h)}const l=new Map;function u(n){if(!l.has(n))throw new g("not a statement",h)}e.bind_collection=function(n,r){u(n);const t=Array.isArray(r),s=e.bind_parameter_count(n);for(let o=1;o<=s;++o){const a=t?o-1:e.bind_parameter_name(n,o),_=r[a];_!==void 0&&e.bind(n,o,_)}return O},e.bind=function(n,r,t){switch(u(n),typeof t){case"number":return t===(t|0)?e.bind_int(n,r,t):e.bind_double(n,r,t);case"string":return e.bind_text(n,r,t);default:return t instanceof Uint8Array||Array.isArray(t)?e.bind_blob(n,r,t):t===null?e.bind_null(n,r):typeof t=="bigint"?e.bind_int64(n,r,t):t===void 0?x:(console.warn("unknown binding converted to null",t),e.bind_null(n,r))}},e.bind_blob=function(){const n="sqlite3_bind_blob",r=c.cwrap(n,...i("nnnnn:n"));return function(t,s,o){u(t);const a=o.byteLength??o.length,_=c._sqlite3_malloc(a);c.HEAPU8.subarray(_).set(o);const T=r(t,s,_,a,b);return w(n,T,l.get(t))}}(),e.bind_parameter_count=function(){const n="sqlite3_bind_parameter_count",r=c.cwrap(n,...i("n:n"));return function(t){return u(t),r(t)}}(),e.bind_double=function(){const n="sqlite3_bind_double",r=c.cwrap(n,...i("nnn:n"));return function(t,s,o){u(t);const a=r(t,s,o);return w(n,a,l.get(t))}}(),e.bind_int=function(){const n="sqlite3_bind_int",r=c.cwrap(n,...i("nnn:n"));return function(t,s,o){if(u(t),o>2147483647||o<-2147483648)return Q;const a=r(t,s,o);return w(n,a,l.get(t))}}(),e.bind_int64=function(){const n="sqlite3_bind_int64",r=c.cwrap(n,...i("nnnn:n"));return function(t,s,o){if(u(t),o>D||o<F)return Q;const a=o&0xffffffffn,_=o>>32n,T=r(t,s,Number(a),Number(_));return w(n,T,l.get(t))}}(),e.bind_null=function(){const n="sqlite3_bind_null",r=c.cwrap(n,...i("nn:n"));return function(t,s){u(t);const o=r(t,s);return w(n,o,l.get(t))}}(),e.bind_parameter_name=function(){const n="sqlite3_bind_parameter_name",r=c.cwrap(n,...i("n:s"));return function(t,s){return u(t),r(t,s)}}(),e.bind_text=function(){const n="sqlite3_bind_text",r=c.cwrap(n,...i("nnnnn:n"));return function(t,s,o){u(t);const a=E(o),_=r(t,s,a,-1,b);return w(n,_,l.get(t))}}(),e.changes=function(){const n="sqlite3_changes",r=c.cwrap(n,...i("n:n"));return function(t){return y(t),r(t)}}(),e.close=function(){const n="sqlite3_close",r=c.cwrap(n,...i("n:n"),{async:v});return async function(t){y(t);const s=await r(t);return L.delete(t),w(n,s,t)}}(),e.column=function(n,r){u(n);const t=e.column_type(n,r);switch(t){case k:return e.column_blob(n,r);case U:return e.column_double(n,r);case P:const s=e.column_int(n,r),o=c.getTempRet0();return q(s,o);case C:return null;case B:return e.column_text(n,r);default:throw new g("unknown type",t)}},e.column_blob=function(){const n="sqlite3_column_blob",r=c.cwrap(n,...i("nn:n"));return function(t,s){u(t);const o=e.column_bytes(t,s),a=r(t,s);return c.HEAPU8.subarray(a,a+o)}}(),e.column_bytes=function(){const n="sqlite3_column_bytes",r=c.cwrap(n,...i("nn:n"));return function(t,s){return u(t),r(t,s)}}(),e.column_count=function(){const n="sqlite3_column_count",r=c.cwrap(n,...i("n:n"));return function(t){return u(t),r(t)}}(),e.column_double=function(){const n="sqlite3_column_double",r=c.cwrap(n,...i("nn:n"));return function(t,s){return u(t),r(t,s)}}(),e.column_int=function(){const n="sqlite3_column_int64",r=c.cwrap(n,...i("nn:n"));return function(t,s){return u(t),r(t,s)}}(),e.column_int64=function(){const n="sqlite3_column_int64",r=c.cwrap(n,...i("nn:n"));return function(t,s){u(t);const o=r(t,s),a=c.getTempRet0();return I(o,a)}}(),e.column_name=function(){const n="sqlite3_column_name",r=c.cwrap(n,...i("nn:s"));return function(t,s){return u(t),r(t,s)}}(),e.column_names=function(n){const r=[],t=e.column_count(n);for(let s=0;s<t;++s)r.push(e.column_name(n,s));return r},e.column_text=function(){const n="sqlite3_column_text",r=c.cwrap(n,...i("nn:s"));return function(t,s){return u(t),r(t,s)}}(),e.column_type=function(){const n="sqlite3_column_type",r=c.cwrap(n,...i("nn:n"));return function(t,s){return u(t),r(t,s)}}(),e.create_function=function(n,r,t,s,o,a,_,T){if(y(n),a&&!_&&!T){const N=c.createFunction(n,r,t,s,o,a);return w("sqlite3_create_function",N,n)}if(!a&&_&&T){const N=c.createAggregate(n,r,t,s,o,_,T);return w("sqlite3_create_function",N,n)}throw new g("invalid function combination",h)},e.create_module=function(n,r,t,s){y(n);const o=c.createModule(n,r,t,s);return w("sqlite3_create_module",o,n)},e.data_count=function(){const n="sqlite3_data_count",r=c.cwrap(n,...i("n:n"));return function(t){return u(t),r(t)}}(),e.declare_vtab=function(){const n="sqlite3_declare_vtab",r=c.cwrap(n,...i("ns:n"));return function(t,s){const o=r(t,s);return w("sqlite3_declare_vtab",o)}}(),e.exec=async function(n,r,t){for await(const s of e.statements(n,r)){let o;for(;await e.step(s)===R;)if(t){o=o??e.column_names(s);const a=e.row(s);await t(a,o)}}return O},e.finalize=function(){const n="sqlite3_finalize",r=c.cwrap(n,...i("n:n"),{async:v});return async function(t){if(!l.has(t))return h;const s=await r(t);return l.get(t),l.delete(t),s}}(),e.get_autocommit=function(){const n="sqlite3_get_autocommit",r=c.cwrap(n,...i("n:n"));return function(t){return r(t)}}(),e.libversion=function(){const n="sqlite3_libversion",r=c.cwrap(n,...i(":s"));return function(){return r()}}(),e.libversion_number=function(){const n="sqlite3_libversion_number",r=c.cwrap(n,...i(":n"));return function(){return r()}}(),e.limit=function(){const n="sqlite3_limit",r=c.cwrap(n,...i("nnn:n"));return function(t,s,o){return r(t,s,o)}}(),e.open_v2=function(){const n="sqlite3_open_v2",r=c.cwrap(n,...i("snnn:n"),{async:v});return async function(t,s,o){s=s||K|d,o=E(o);const a=await r(t,f[0],s,o),_=c.getValue(f[0],"*");return L.add(_),c._sqlite3_free(o),c.ccall("RegisterExtensionFunctions","void",["number"],[_]),w(n,a),_}}(),e.prepare_v2=function(){const n="sqlite3_prepare_v2",r=c.cwrap(n,...i("nnnnn:n"),{async:v});return async function(t,s){const o=await r(t,s,-1,f[0],f[1]);w(n,o,t);const a=c.getValue(f[0],"*");return a?(l.set(a,t),{stmt:a,sql:c.getValue(f[1],"*")}):null}}(),e.progress_handler=function(n,r,t,s){y(n),c.progressHandler(n,r,t,s)},e.reset=function(){const n="sqlite3_reset",r=c.cwrap(n,...i("n:n"),{async:v});return async function(t){u(t);const s=await r(t);return w(n,s,l.get(t))}}(),e.result=function(n,r){switch(typeof r){case"number":r===(r|0)?e.result_int(n,r):e.result_double(n,r);break;case"string":e.result_text(n,r);break;default:if(r instanceof Uint8Array||Array.isArray(r))e.result_blob(n,r);else if(r===null)e.result_null(n);else{if(typeof r=="bigint")return e.result_int64(n,r);console.warn("unknown result converted to null",r),e.result_null(n)}break}},e.result_blob=function(){const n="sqlite3_result_blob",r=c.cwrap(n,...i("nnnn:n"));return function(t,s){const o=s.byteLength??s.length,a=c._sqlite3_malloc(o);c.HEAPU8.subarray(a).set(s),r(t,a,o,b)}}(),e.result_double=function(){const n="sqlite3_result_double",r=c.cwrap(n,...i("nn:n"));return function(t,s){r(t,s)}}(),e.result_int=function(){const n="sqlite3_result_int",r=c.cwrap(n,...i("nn:n"));return function(t,s){r(t,s)}}(),e.result_int64=function(){const n="sqlite3_result_int64",r=c.cwrap(n,...i("nnn:n"));return function(t,s){if(s>D||s<F)return Q;const o=s&0xffffffffn,a=s>>32n;r(t,Number(o),Number(a))}}(),e.result_null=function(){const n="sqlite3_result_null",r=c.cwrap(n,...i("n:n"));return function(t){r(t)}}(),e.result_text=function(){const n="sqlite3_result_text",r=c.cwrap(n,...i("nnnn:n"));return function(t,s){const o=E(s);r(t,o,-1,b)}}(),e.row=function(n){const r=[],t=e.data_count(n);for(let s=0;s<t;++s){const o=e.column(n,s);r.push(o?.buffer===c.HEAPU8.buffer?o.slice():o)}return r},e.set_authorizer=function(n,r,t){y(n);const s=c.setAuthorizer(n,r,t);return w("sqlite3_set_authorizer",s,n)},e.sql=function(){const n="sqlite3_sql",r=c.cwrap(n,...i("n:s"));return function(t){return u(t),r(t)}}(),e.statements=function(n,r){return async function*(){const t=e.str_new(n,r);let s={stmt:null,sql:e.str_value(t)};try{for(;s=await e.prepare_v2(n,s.sql);)yield s.stmt,e.finalize(s.stmt),s.stmt=null}finally{s?.stmt&&e.finalize(s.stmt),e.str_finish(t)}}()},e.step=function(){const n="sqlite3_step",r=c.cwrap(n,...i("n:n"),{async:v});return async function(t){u(t);const s=await r(t);return w(n,s,l.get(t),[R,H])}}();let A=0;const m=new Map;e.str_new=function(n,r=""){const t=c.lengthBytesUTF8(r),s=A++&4294967295,o={offset:c._sqlite3_malloc(t+1),bytes:t};return m.set(s,o),c.stringToUTF8(r,o.offset,o.bytes+1),s},e.str_appendall=function(n,r){if(!m.has(n))throw new g("not a string",h);const t=m.get(n),s=c.lengthBytesUTF8(r),o=t.bytes+s,a=c._sqlite3_malloc(o+1);c.HEAPU8.subarray(a,a+o+1).set(c.HEAPU8.subarray(t.offset,t.offset+t.bytes)),c.stringToUTF8(r,a+t.bytes,s+1),c._sqlite3_free(t.offset),t.offset=a,t.bytes=o,m.set(n,t)},e.str_finish=function(n){if(!m.has(n))throw new g("not a string",h);const r=m.get(n);m.delete(n),c._sqlite3_free(r.offset)},e.str_value=function(n){if(!m.has(n))throw new g("not a string",h);return m.get(n).offset},e.user_data=function(n){return c.getFunctionUserData(n)},e.value=function(n){const r=e.value_type(n);switch(r){case k:return e.value_blob(n);case U:return e.value_double(n);case P:const t=e.value_int(n),s=c.getTempRet0();return q(t,s);case C:return null;case B:return e.value_text(n);default:throw new g("unknown type",r)}},e.value_blob=function(){const n="sqlite3_value_blob",r=c.cwrap(n,...i("n:n"));return function(t){const s=e.value_bytes(t),o=r(t);return c.HEAPU8.subarray(o,o+s)}}(),e.value_bytes=function(){const n="sqlite3_value_bytes",r=c.cwrap(n,...i("n:n"));return function(t){return r(t)}}(),e.value_double=function(){const n="sqlite3_value_double",r=c.cwrap(n,...i("n:n"));return function(t){return r(t)}}(),e.value_int=function(){const n="sqlite3_value_int64",r=c.cwrap(n,...i("n:n"));return function(t){return r(t)}}(),e.value_int64=function(){const n="sqlite3_value_int64",r=c.cwrap(n,...i("n:n"));return function(t){const s=r(t),o=c.getTempRet0();return I(s,o)}}(),e.value_text=function(){const n="sqlite3_value_text",r=c.cwrap(n,...i("n:s"));return function(t){return r(t)}}(),e.value_type=function(){const n="sqlite3_value_type",r=c.cwrap(n,...i("n:n"));return function(t){return r(t)}}(),e.vfs_register=function(n,r){const t=c.registerVFS(n,r);return w("sqlite3_vfs_register",t)};function w(n,r,t=null,s=[O]){if(s.includes(r))return r;const o=t?c.ccall("sqlite3_errmsg","string",["number"],[t]):n;throw new g(o,r)}return e}function i(c){const e=[],b=c.match(/([ns@]*):([nsv@])/);switch(b[2]){case"n":e.push("number");break;case"s":e.push("string");break;case"v":e.push(null);break}const p=[];for(let f of b[1])switch(f){case"n":p.push("number");break;case"s":p.push("string");break}return e.push(p),e}async function G(c){const{fileName:e,sqliteModule:b,vfs:p}=await c,f=z(b);f.vfs_register(p);const E=await f.open_v2(e);return{db:E,sqlite:f,async close(){await f.close(E)},changes(){return f.changes(E)},async lastInsertRowId(){return await new Promise(I=>f.exec(E,"SELECT last_insert_rowid()",([q])=>I(q)))},async run(I,q){const L=f.str_new(E,I);try{const y=await f.prepare_v2(E,f.str_value(L));if(!y)return[];const l=y.stmt;try{q?.length&&f.bind_collection(l,q);const u=[],A=f.column_names(l);for(;await f.step(l)===R;){const m=f.row(l);u.push(Object.fromEntries(A.map((w,n)=>[w,m[n]])))}return u}finally{await f.finalize(l)}}finally{f.str_finish(L)}}}}var S;async function W({fileName:c,useOPFS:e,url:b}){S=await G((e?(await import("./opfs-MNNGSZVZ-b80f694d.js")).useOpfsStorage:(await import("./idb-G5HOWJFN-f3e7ebce.js")).useIdbStorage)(c,{url:b}))}async function X({isSelect:c,sql:e,parameters:b}){const p=await S.run(e,b);return c||p.length?{rows:p}:{rows:p,insertId:BigInt(await S.lastInsertRowId()),numAffectedRows:BigInt(S.changes())}}onmessage=async c=>{const e=c.data,b={type:e.type,data:null,err:null};try{switch(e.type){case"init":await W(e);break;case"run":b.data=await X(e);break;case"close":await S.close();break}}catch(p){b.err=p}postMessage(b)};export{K as S,O as a,Z as b,nn as c,V as d,J as e,wn as f,tn as g,rn as h,en as i,sn as j,M as k,on as l,bn as m,_n as n,ln as o,Y as p,cn as q,j as r,$ as s,an as t,fn as u,un as v};
