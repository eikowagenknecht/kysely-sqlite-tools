var O=0,J=5,Y=10,Z=12,$=14,h=21,Q=25,x=27,R=100,H=101,V=3850,M=522,d=1,K=2,z=4,nn=8,tn=256,rn=2048,en=16384,sn=524288,cn=0,on=1,an=2,un=3,fn=4,_n=512,ln=1024,wn=2048,bn=16384,P=1,U=2,B=3,k=4,C=5,D=0x7fffffffffffffffn,F=-0x8000000000000000n,I=class extends Error{constructor(c,e){super(c),this.code=e}},v=!0;function G(c){const e={},w=c._getSqliteFree(),p=c._malloc(8),m=[p,p+4];function _(n){if(typeof n!="string")return 0;const r=c.lengthBytesUTF8(n),t=c._sqlite3_malloc(r+1);return c.stringToUTF8(n,t,r+1),t}function y(n,r){return BigInt(r)<<32n|BigInt(n)&0xffffffffn}const L=function(){const n=BigInt(Number.MAX_SAFE_INTEGER)>>32n,r=BigInt(Number.MIN_SAFE_INTEGER)>>32n;return function(t,s){return s>n||s<r?y(t,s):s*4294967296+(t&2147483647)-(t&2147483648)}}(),q=new Set;function g(n){if(!q.has(n))throw new I("not a database",h)}const b=new Map;function u(n){if(!b.has(n))throw new I("not a statement",h)}e.bind_collection=function(n,r){u(n);const t=Array.isArray(r),s=e.bind_parameter_count(n);for(let o=1;o<=s;++o){const a=t?o-1:e.bind_parameter_name(n,o),f=r[a];f!==void 0&&e.bind(n,o,f)}return O},e.bind=function(n,r,t){switch(u(n),typeof t){case"number":return t===(t|0)?e.bind_int(n,r,t):e.bind_double(n,r,t);case"string":return e.bind_text(n,r,t);default:return t instanceof Uint8Array||Array.isArray(t)?e.bind_blob(n,r,t):t===null?e.bind_null(n,r):typeof t=="bigint"?e.bind_int64(n,r,t):t===void 0?x:(console.warn("unknown binding converted to null",t),e.bind_null(n,r))}},e.bind_blob=function(){const n="sqlite3_bind_blob",r=c.cwrap(n,...i("nnnnn:n"));return function(t,s,o){u(t);const a=o.byteLength??o.length,f=c._sqlite3_malloc(a);c.HEAPU8.subarray(f).set(o);const T=r(t,s,f,a,w);return l(n,T,b.get(t))}}(),e.bind_parameter_count=function(){const n="sqlite3_bind_parameter_count",r=c.cwrap(n,...i("n:n"));return function(t){return u(t),r(t)}}(),e.bind_double=function(){const n="sqlite3_bind_double",r=c.cwrap(n,...i("nnn:n"));return function(t,s,o){u(t);const a=r(t,s,o);return l(n,a,b.get(t))}}(),e.bind_int=function(){const n="sqlite3_bind_int",r=c.cwrap(n,...i("nnn:n"));return function(t,s,o){if(u(t),o>2147483647||o<-2147483648)return Q;const a=r(t,s,o);return l(n,a,b.get(t))}}(),e.bind_int64=function(){const n="sqlite3_bind_int64",r=c.cwrap(n,...i("nnnn:n"));return function(t,s,o){if(u(t),o>D||o<F)return Q;const a=o&0xffffffffn,f=o>>32n,T=r(t,s,Number(a),Number(f));return l(n,T,b.get(t))}}(),e.bind_null=function(){const n="sqlite3_bind_null",r=c.cwrap(n,...i("nn:n"));return function(t,s){u(t);const o=r(t,s);return l(n,o,b.get(t))}}(),e.bind_parameter_name=function(){const n="sqlite3_bind_parameter_name",r=c.cwrap(n,...i("n:s"));return function(t,s){return u(t),r(t,s)}}(),e.bind_text=function(){const n="sqlite3_bind_text",r=c.cwrap(n,...i("nnnnn:n"));return function(t,s,o){u(t);const a=_(o),f=r(t,s,a,-1,w);return l(n,f,b.get(t))}}(),e.changes=function(){const n="sqlite3_changes",r=c.cwrap(n,...i("n:n"));return function(t){return g(t),r(t)}}(),e.close=function(){const n="sqlite3_close",r=c.cwrap(n,...i("n:n"),{async:v});return async function(t){g(t);const s=await r(t);return q.delete(t),l(n,s,t)}}(),e.column=function(n,r){u(n);const t=e.column_type(n,r);switch(t){case k:return e.column_blob(n,r);case U:return e.column_double(n,r);case P:const s=e.column_int(n,r),o=c.getTempRet0();return L(s,o);case C:return null;case B:return e.column_text(n,r);default:throw new I("unknown type",t)}},e.column_blob=function(){const n="sqlite3_column_blob",r=c.cwrap(n,...i("nn:n"));return function(t,s){u(t);const o=e.column_bytes(t,s),a=r(t,s);return c.HEAPU8.subarray(a,a+o)}}(),e.column_bytes=function(){const n="sqlite3_column_bytes",r=c.cwrap(n,...i("nn:n"));return function(t,s){return u(t),r(t,s)}}(),e.column_count=function(){const n="sqlite3_column_count",r=c.cwrap(n,...i("n:n"));return function(t){return u(t),r(t)}}(),e.column_double=function(){const n="sqlite3_column_double",r=c.cwrap(n,...i("nn:n"));return function(t,s){return u(t),r(t,s)}}(),e.column_int=function(){const n="sqlite3_column_int64",r=c.cwrap(n,...i("nn:n"));return function(t,s){return u(t),r(t,s)}}(),e.column_int64=function(){const n="sqlite3_column_int64",r=c.cwrap(n,...i("nn:n"));return function(t,s){u(t);const o=r(t,s),a=c.getTempRet0();return y(o,a)}}(),e.column_name=function(){const n="sqlite3_column_name",r=c.cwrap(n,...i("nn:s"));return function(t,s){return u(t),r(t,s)}}(),e.column_names=function(n){const r=[],t=e.column_count(n);for(let s=0;s<t;++s)r.push(e.column_name(n,s));return r},e.column_text=function(){const n="sqlite3_column_text",r=c.cwrap(n,...i("nn:s"));return function(t,s){return u(t),r(t,s)}}(),e.column_type=function(){const n="sqlite3_column_type",r=c.cwrap(n,...i("nn:n"));return function(t,s){return u(t),r(t,s)}}(),e.create_function=function(n,r,t,s,o,a,f,T){if(g(n),a&&!f&&!T){const N=c.createFunction(n,r,t,s,o,a);return l("sqlite3_create_function",N,n)}if(!a&&f&&T){const N=c.createAggregate(n,r,t,s,o,f,T);return l("sqlite3_create_function",N,n)}throw new I("invalid function combination",h)},e.create_module=function(n,r,t,s){g(n);const o=c.createModule(n,r,t,s);return l("sqlite3_create_module",o,n)},e.data_count=function(){const n="sqlite3_data_count",r=c.cwrap(n,...i("n:n"));return function(t){return u(t),r(t)}}(),e.declare_vtab=function(){const n="sqlite3_declare_vtab",r=c.cwrap(n,...i("ns:n"));return function(t,s){const o=r(t,s);return l("sqlite3_declare_vtab",o)}}(),e.exec=async function(n,r,t){for await(const s of e.statements(n,r)){let o;for(;await e.step(s)===R;)if(t){o=o??e.column_names(s);const a=e.row(s);await t(a,o)}}return O},e.finalize=function(){const n="sqlite3_finalize",r=c.cwrap(n,...i("n:n"),{async:v});return async function(t){if(!b.has(t))return h;const s=await r(t);return b.get(t),b.delete(t),s}}(),e.get_autocommit=function(){const n="sqlite3_get_autocommit",r=c.cwrap(n,...i("n:n"));return function(t){return r(t)}}(),e.libversion=function(){const n="sqlite3_libversion",r=c.cwrap(n,...i(":s"));return function(){return r()}}(),e.libversion_number=function(){const n="sqlite3_libversion_number",r=c.cwrap(n,...i(":n"));return function(){return r()}}(),e.limit=function(){const n="sqlite3_limit",r=c.cwrap(n,...i("nnn:n"));return function(t,s,o){return r(t,s,o)}}(),e.open_v2=function(){const n="sqlite3_open_v2",r=c.cwrap(n,...i("snnn:n"),{async:v});return async function(t,s,o){s=s||z|K,o=_(o);const a=await r(t,m[0],s,o),f=c.getValue(m[0],"*");return q.add(f),c._sqlite3_free(o),c.ccall("RegisterExtensionFunctions","void",["number"],[f]),l(n,a),f}}(),e.prepare_v2=function(){const n="sqlite3_prepare_v2",r=c.cwrap(n,...i("nnnnn:n"),{async:v});return async function(t,s){const o=await r(t,s,-1,m[0],m[1]);l(n,o,t);const a=c.getValue(m[0],"*");return a?(b.set(a,t),{stmt:a,sql:c.getValue(m[1],"*")}):null}}(),e.progress_handler=function(n,r,t,s){g(n),c.progressHandler(n,r,t,s)},e.reset=function(){const n="sqlite3_reset",r=c.cwrap(n,...i("n:n"),{async:v});return async function(t){u(t);const s=await r(t);return l(n,s,b.get(t))}}(),e.result=function(n,r){switch(typeof r){case"number":r===(r|0)?e.result_int(n,r):e.result_double(n,r);break;case"string":e.result_text(n,r);break;default:if(r instanceof Uint8Array||Array.isArray(r))e.result_blob(n,r);else if(r===null)e.result_null(n);else{if(typeof r=="bigint")return e.result_int64(n,r);console.warn("unknown result converted to null",r),e.result_null(n)}break}},e.result_blob=function(){const n="sqlite3_result_blob",r=c.cwrap(n,...i("nnnn:n"));return function(t,s){const o=s.byteLength??s.length,a=c._sqlite3_malloc(o);c.HEAPU8.subarray(a).set(s),r(t,a,o,w)}}(),e.result_double=function(){const n="sqlite3_result_double",r=c.cwrap(n,...i("nn:n"));return function(t,s){r(t,s)}}(),e.result_int=function(){const n="sqlite3_result_int",r=c.cwrap(n,...i("nn:n"));return function(t,s){r(t,s)}}(),e.result_int64=function(){const n="sqlite3_result_int64",r=c.cwrap(n,...i("nnn:n"));return function(t,s){if(s>D||s<F)return Q;const o=s&0xffffffffn,a=s>>32n;r(t,Number(o),Number(a))}}(),e.result_null=function(){const n="sqlite3_result_null",r=c.cwrap(n,...i("n:n"));return function(t){r(t)}}(),e.result_text=function(){const n="sqlite3_result_text",r=c.cwrap(n,...i("nnnn:n"));return function(t,s){const o=_(s);r(t,o,-1,w)}}(),e.row=function(n){const r=[],t=e.data_count(n);for(let s=0;s<t;++s){const o=e.column(n,s);r.push(o?.buffer===c.HEAPU8.buffer?o.slice():o)}return r},e.set_authorizer=function(n,r,t){g(n);const s=c.setAuthorizer(n,r,t);return l("sqlite3_set_authorizer",s,n)},e.sql=function(){const n="sqlite3_sql",r=c.cwrap(n,...i("n:s"));return function(t){return u(t),r(t)}}(),e.statements=function(n,r){return async function*(){const t=e.str_new(n,r);let s={stmt:null,sql:e.str_value(t)};try{for(;s=await e.prepare_v2(n,s.sql);)yield s.stmt,e.finalize(s.stmt),s.stmt=null}finally{s?.stmt&&e.finalize(s.stmt),e.str_finish(t)}}()},e.step=function(){const n="sqlite3_step",r=c.cwrap(n,...i("n:n"),{async:v});return async function(t){u(t);const s=await r(t);return l(n,s,b.get(t),[R,H])}}();let A=0;const E=new Map;e.str_new=function(n,r=""){const t=c.lengthBytesUTF8(r),s=A++&4294967295,o={offset:c._sqlite3_malloc(t+1),bytes:t};return E.set(s,o),c.stringToUTF8(r,o.offset,o.bytes+1),s},e.str_appendall=function(n,r){if(!E.has(n))throw new I("not a string",h);const t=E.get(n),s=c.lengthBytesUTF8(r),o=t.bytes+s,a=c._sqlite3_malloc(o+1);c.HEAPU8.subarray(a,a+o+1).set(c.HEAPU8.subarray(t.offset,t.offset+t.bytes)),c.stringToUTF8(r,a+t.bytes,s+1),c._sqlite3_free(t.offset),t.offset=a,t.bytes=o,E.set(n,t)},e.str_finish=function(n){if(!E.has(n))throw new I("not a string",h);const r=E.get(n);E.delete(n),c._sqlite3_free(r.offset)},e.str_value=function(n){if(!E.has(n))throw new I("not a string",h);return E.get(n).offset},e.user_data=function(n){return c.getFunctionUserData(n)},e.value=function(n){const r=e.value_type(n);switch(r){case k:return e.value_blob(n);case U:return e.value_double(n);case P:const t=e.value_int(n),s=c.getTempRet0();return L(t,s);case C:return null;case B:return e.value_text(n);default:throw new I("unknown type",r)}},e.value_blob=function(){const n="sqlite3_value_blob",r=c.cwrap(n,...i("n:n"));return function(t){const s=e.value_bytes(t),o=r(t);return c.HEAPU8.subarray(o,o+s)}}(),e.value_bytes=function(){const n="sqlite3_value_bytes",r=c.cwrap(n,...i("n:n"));return function(t){return r(t)}}(),e.value_double=function(){const n="sqlite3_value_double",r=c.cwrap(n,...i("n:n"));return function(t){return r(t)}}(),e.value_int=function(){const n="sqlite3_value_int64",r=c.cwrap(n,...i("n:n"));return function(t){return r(t)}}(),e.value_int64=function(){const n="sqlite3_value_int64",r=c.cwrap(n,...i("n:n"));return function(t){const s=r(t),o=c.getTempRet0();return y(s,o)}}(),e.value_text=function(){const n="sqlite3_value_text",r=c.cwrap(n,...i("n:s"));return function(t){return r(t)}}(),e.value_type=function(){const n="sqlite3_value_type",r=c.cwrap(n,...i("n:n"));return function(t){return r(t)}}(),e.vfs_register=function(n,r){const t=c.registerVFS(n,r);return l("sqlite3_vfs_register",t)};function l(n,r,t=null,s=[O]){if(s.includes(r))return r;const o=t?c.ccall("sqlite3_errmsg","string",["number"],[t]):n;throw new I(o,r)}return e}function i(c){const e=[],w=c.match(/([ns@]*):([nsv@])/);switch(w[2]){case"n":e.push("number");break;case"s":e.push("string");break;case"v":e.push(null);break}const p=[];for(let m of w[1])switch(m){case"n":p.push("number");break;case"s":p.push("string");break}return e.push(p),e}async function W(c,e){const{path:w,sqliteModule:p,vfs:m}=await c,_=G(p);_.vfs_register(m,!0);const y=await _.open_v2(w,e?d:void 0);return{path:w,vfs:m,db:y,sqlite:_,async close(){await _.close(y)},changes(){return _.changes(y)},async lastInsertRowId(){return await new Promise(L=>_.exec(y,"SELECT last_insert_rowid()",([q])=>L(q)))},async run(L,q){const g=_.str_new(y,L);try{const b=await _.prepare_v2(y,_.str_value(g));if(!b)return[];const u=b.stmt;try{q?.length&&_.bind_collection(u,q);const A=[],E=_.column_names(u);for(;await _.step(u)===R;){const l=_.row(u);A.push(Object.fromEntries(E.map((n,r)=>[n,l[r]])))}return A}finally{await _.finalize(u)}}finally{_.str_finish(g)}}}}var S;async function X({fileName:c,useOPFS:e,url:w}){S=await W((e?(await import("./opfs-UQFEXXKW-bpAf86xV.js")).useOpfsStorage:(await import("./idb-ZW3EH5GU-CHT-7oMt.js")).useIdbStorage)(c,{url:w}))}async function j({isSelect:c,sql:e,parameters:w}){const p=await S.run(e,w);return c||p.length?{rows:p}:{rows:p,insertId:BigInt(await S.lastInsertRowId()),numAffectedRows:BigInt(S.changes())}}onmessage=async c=>{const e=c.data,w={type:e.type,data:null,err:null};try{switch(e.type){case"init":await X(e);break;case"run":w.data=await j(e);break;case"close":await S.close();break}}catch(p){w.err=p}postMessage(w)};export{z as S,d as a,O as b,$ as c,nn as d,Y as e,M as f,on as g,bn as h,_n as i,ln as j,wn as k,Z as l,cn as m,J as n,V as o,an as p,fn as q,un as r,tn as s,rn as t,en as u,sn as v};
