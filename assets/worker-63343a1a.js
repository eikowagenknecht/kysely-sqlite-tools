var I=0,X=5,J=10,K=12,Q=14,v=21,F=25,V=27,N=100,L=101,W=3850,Y=522,Z=1,O=2,$=4,nn=8,tn=256,en=2048,rn=16384,un=524288,ln=0,an=1,sn=2,on=3,fn=4,cn=512,_n=1024,bn=2048,wn=16384,R=1,S=2,B=3,P=4,z=5,H=0x7fffffffffffffffn,M=-0x8000000000000000n,q=class extends Error{constructor(l,r){super(l),this.code=r}},x=!0;function pn(l){let r={},o=l._getSqliteFree(),c=l._malloc(8),p=[c,c+4];function d(n){if(typeof n!="string")return 0;let e=l.lengthBytesUTF8(n),t=l._sqlite3_malloc(e+1);return l.stringToUTF8(n,t,e+1),t}function A(n,e){return BigInt(e)<<32n|BigInt(n)&0xffffffffn}let E=function(){let n=BigInt(Number.MAX_SAFE_INTEGER)>>32n,e=BigInt(Number.MIN_SAFE_INTEGER)>>32n;return function(t,u){return u>n||u<e?A(t,u):u*4294967296+(t&2147483647)-(t&2147483648)}}(),y=new Set;function g(n){if(!y.has(n))throw new q("not a database",v)}let w=new Map;function f(n){if(!w.has(n))throw new q("not a statement",v)}r.bind_collection=function(n,e){f(n);let t=Array.isArray(e),u=r.bind_parameter_count(n);for(let i=1;i<=u;++i){let s=t?i-1:r.bind_parameter_name(n,i),b=e[s];b!==void 0&&r.bind(n,i,b)}return I},r.bind=function(n,e,t){switch(f(n),typeof t){case"number":return t===(t|0)?r.bind_int(n,e,t):r.bind_double(n,e,t);case"string":return r.bind_text(n,e,t);default:return t instanceof Uint8Array||Array.isArray(t)?r.bind_blob(n,e,t):t===null?r.bind_null(n,e):typeof t=="bigint"?r.bind_int64(n,e,t):t===void 0?V:(console.warn("unknown binding converted to null",t),r.bind_null(n,e))}},r.bind_blob=function(){let n="sqlite3_bind_blob",e=l.cwrap(n,...a("nnnnn:n"));return function(t,u,i){f(t);let s=i.byteLength??i.length,b=l._sqlite3_malloc(s);l.HEAPU8.subarray(b).set(i);let h=e(t,u,b,s,o);return _(n,h,w.get(t))}}(),r.bind_parameter_count=function(){let n="sqlite3_bind_parameter_count",e=l.cwrap(n,...a("n:n"));return function(t){return f(t),e(t)}}(),r.bind_double=function(){let n="sqlite3_bind_double",e=l.cwrap(n,...a("nnn:n"));return function(t,u,i){f(t);let s=e(t,u,i);return _(n,s,w.get(t))}}(),r.bind_int=function(){let n="sqlite3_bind_int",e=l.cwrap(n,...a("nnn:n"));return function(t,u,i){if(f(t),i>2147483647||i<-2147483648)return F;let s=e(t,u,i);return _(n,s,w.get(t))}}(),r.bind_int64=function(){let n="sqlite3_bind_int64",e=l.cwrap(n,...a("nnnn:n"));return function(t,u,i){if(f(t),i>H||i<M)return F;let s=i&0xffffffffn,b=i>>32n,h=e(t,u,Number(s),Number(b));return _(n,h,w.get(t))}}(),r.bind_null=function(){let n="sqlite3_bind_null",e=l.cwrap(n,...a("nn:n"));return function(t,u){f(t);let i=e(t,u);return _(n,i,w.get(t))}}(),r.bind_parameter_name=function(){let n="sqlite3_bind_parameter_name",e=l.cwrap(n,...a("n:s"));return function(t,u){return f(t),e(t,u)}}(),r.bind_text=function(){let n="sqlite3_bind_text",e=l.cwrap(n,...a("nnnnn:n"));return function(t,u,i){f(t);let s=d(i),b=e(t,u,s,-1,o);return _(n,b,w.get(t))}}(),r.changes=function(){let n="sqlite3_changes",e=l.cwrap(n,...a("n:n"));return function(t){return g(t),e(t)}}(),r.close=function(){let n="sqlite3_close",e=l.cwrap(n,...a("n:n"),{async:x});return async function(t){g(t);let u=await e(t);return y.delete(t),_(n,u,t)}}(),r.column=function(n,e){f(n);let t=r.column_type(n,e);switch(t){case P:return r.column_blob(n,e);case S:return r.column_double(n,e);case R:let u=r.column_int(n,e),i=l.getTempRet0();return E(u,i);case z:return null;case B:return r.column_text(n,e);default:throw new q("unknown type",t)}},r.column_blob=function(){let n="sqlite3_column_blob",e=l.cwrap(n,...a("nn:n"));return function(t,u){f(t);let i=r.column_bytes(t,u),s=e(t,u);return l.HEAPU8.subarray(s,s+i)}}(),r.column_bytes=function(){let n="sqlite3_column_bytes",e=l.cwrap(n,...a("nn:n"));return function(t,u){return f(t),e(t,u)}}(),r.column_count=function(){let n="sqlite3_column_count",e=l.cwrap(n,...a("n:n"));return function(t){return f(t),e(t)}}(),r.column_double=function(){let n="sqlite3_column_double",e=l.cwrap(n,...a("nn:n"));return function(t,u){return f(t),e(t,u)}}(),r.column_int=function(){let n="sqlite3_column_int64",e=l.cwrap(n,...a("nn:n"));return function(t,u){return f(t),e(t,u)}}(),r.column_int64=function(){let n="sqlite3_column_int64",e=l.cwrap(n,...a("nn:n"));return function(t,u){f(t);let i=e(t,u),s=l.getTempRet0();return A(i,s)}}(),r.column_name=function(){let n="sqlite3_column_name",e=l.cwrap(n,...a("nn:s"));return function(t,u){return f(t),e(t,u)}}(),r.column_names=function(n){let e=[],t=r.column_count(n);for(let u=0;u<t;++u)e.push(r.column_name(n,u));return e},r.column_text=function(){let n="sqlite3_column_text",e=l.cwrap(n,...a("nn:s"));return function(t,u){return f(t),e(t,u)}}(),r.column_type=function(){let n="sqlite3_column_type",e=l.cwrap(n,...a("nn:n"));return function(t,u){return f(t),e(t,u)}}(),r.create_function=function(n,e,t,u,i,s,b,h){if(g(n),s&&!b&&!h){let k=l.createFunction(n,e,t,u,i,s);return _("sqlite3_create_function",k,n)}if(!s&&b&&h){let k=l.createAggregate(n,e,t,u,i,b,h);return _("sqlite3_create_function",k,n)}throw new q("invalid function combination",v)},r.create_module=function(n,e,t,u){g(n);let i=l.createModule(n,e,t,u);return _("sqlite3_create_module",i,n)},r.data_count=function(){let n="sqlite3_data_count",e=l.cwrap(n,...a("n:n"));return function(t){return f(t),e(t)}}(),r.declare_vtab=function(){let n="sqlite3_declare_vtab",e=l.cwrap(n,...a("ns:n"));return function(t,u){let i=e(t,u);return _("sqlite3_declare_vtab",i)}}(),r.exec=async function(n,e,t){for await(let u of r.statements(n,e)){let i;for(;await r.step(u)===N;)if(t){i=i??r.column_names(u);let s=r.row(u);await t(s,i)}}return I},r.finalize=function(){let n="sqlite3_finalize",e=l.cwrap(n,...a("n:n"),{async:x});return async function(t){if(!w.has(t))return v;let u=await e(t);return w.get(t),w.delete(t),u}}(),r.get_autocommit=function(){let n="sqlite3_get_autocommit",e=l.cwrap(n,...a("n:n"));return function(t){return e(t)}}(),r.libversion=function(){let n="sqlite3_libversion",e=l.cwrap(n,...a(":s"));return function(){return e()}}(),r.libversion_number=function(){let n="sqlite3_libversion_number",e=l.cwrap(n,...a(":n"));return function(){return e()}}(),r.limit=function(){let n="sqlite3_limit",e=l.cwrap(n,...a("nnn:n"));return function(t,u,i){return e(t,u,i)}}(),r.open_v2=function(){let n="sqlite3_open_v2",e=l.cwrap(n,...a("snnn:n"),{async:x});return async function(t,u,i){u=u||$|O,i=d(i);let s=await e(t,p[0],u,i),b=l.getValue(p[0],"*");return y.add(b),l._sqlite3_free(i),l.ccall("RegisterExtensionFunctions","void",["number"],[b]),_(n,s),b}}(),r.prepare_v2=function(){let n="sqlite3_prepare_v2",e=l.cwrap(n,...a("nnnnn:n"),{async:x});return async function(t,u){let i=await e(t,u,-1,p[0],p[1]);_(n,i,t);let s=l.getValue(p[0],"*");return s?(w.set(s,t),{stmt:s,sql:l.getValue(p[1],"*")}):null}}(),r.progress_handler=function(n,e,t,u){g(n),l.progressHandler(n,e,t,u)},r.reset=function(){let n="sqlite3_reset",e=l.cwrap(n,...a("n:n"),{async:x});return async function(t){f(t);let u=await e(t);return _(n,u,w.get(t))}}(),r.result=function(n,e){switch(typeof e){case"number":e===(e|0)?r.result_int(n,e):r.result_double(n,e);break;case"string":r.result_text(n,e);break;default:if(e instanceof Uint8Array||Array.isArray(e))r.result_blob(n,e);else if(e===null)r.result_null(n);else{if(typeof e=="bigint")return r.result_int64(n,e);console.warn("unknown result converted to null",e),r.result_null(n)}break}},r.result_blob=function(){let n="sqlite3_result_blob",e=l.cwrap(n,...a("nnnn:n"));return function(t,u){let i=u.byteLength??u.length,s=l._sqlite3_malloc(i);l.HEAPU8.subarray(s).set(u),e(t,s,i,o)}}(),r.result_double=function(){let n="sqlite3_result_double",e=l.cwrap(n,...a("nn:n"));return function(t,u){e(t,u)}}(),r.result_int=function(){let n="sqlite3_result_int",e=l.cwrap(n,...a("nn:n"));return function(t,u){e(t,u)}}(),r.result_int64=function(){let n="sqlite3_result_int64",e=l.cwrap(n,...a("nnn:n"));return function(t,u){if(u>H||u<M)return F;let i=u&0xffffffffn,s=u>>32n;e(t,Number(i),Number(s))}}(),r.result_null=function(){let n="sqlite3_result_null",e=l.cwrap(n,...a("n:n"));return function(t){e(t)}}(),r.result_text=function(){let n="sqlite3_result_text",e=l.cwrap(n,...a("nnnn:n"));return function(t,u){let i=d(u);e(t,i,-1,o)}}(),r.row=function(n){let e=[],t=r.data_count(n);for(let u=0;u<t;++u){let i=r.column(n,u);e.push(i?.buffer===l.HEAPU8.buffer?i.slice():i)}return e},r.set_authorizer=function(n,e,t){g(n);let u=l.setAuthorizer(n,e,t);return _("sqlite3_set_authorizer",u,n)},r.sql=function(){let n="sqlite3_sql",e=l.cwrap(n,...a("n:s"));return function(t){return f(t),e(t)}}(),r.statements=function(n,e){return async function*(){let t=r.str_new(n,e),u={stmt:null,sql:r.str_value(t)};try{for(;u=await r.prepare_v2(n,u.sql);)yield u.stmt,r.finalize(u.stmt),u.stmt=null}finally{u?.stmt&&r.finalize(u.stmt),r.str_finish(t)}}()},r.step=function(){let n="sqlite3_step",e=l.cwrap(n,...a("n:n"),{async:x});return async function(t){f(t);let u=await e(t);return _(n,u,w.get(t),[N,L])}}();let U=0,m=new Map;r.str_new=function(n,e=""){let t=l.lengthBytesUTF8(e),u=U++&4294967295,i={offset:l._sqlite3_malloc(t+1),bytes:t};return m.set(u,i),l.stringToUTF8(e,i.offset,i.bytes+1),u},r.str_appendall=function(n,e){if(!m.has(n))throw new q("not a string",v);let t=m.get(n),u=l.lengthBytesUTF8(e),i=t.bytes+u,s=l._sqlite3_malloc(i+1);l.HEAPU8.subarray(s,s+i+1).set(l.HEAPU8.subarray(t.offset,t.offset+t.bytes)),l.stringToUTF8(e,s+t.bytes,u+1),l._sqlite3_free(t.offset),t.offset=s,t.bytes=i,m.set(n,t)},r.str_finish=function(n){if(!m.has(n))throw new q("not a string",v);let e=m.get(n);m.delete(n),l._sqlite3_free(e.offset)},r.str_value=function(n){if(!m.has(n))throw new q("not a string",v);return m.get(n).offset},r.user_data=function(n){return l.getFunctionUserData(n)},r.value=function(n){let e=r.value_type(n);switch(e){case P:return r.value_blob(n);case S:return r.value_double(n);case R:let t=r.value_int(n),u=l.getTempRet0();return E(t,u);case z:return null;case B:return r.value_text(n);default:throw new q("unknown type",e)}},r.value_blob=function(){let n="sqlite3_value_blob",e=l.cwrap(n,...a("n:n"));return function(t){let u=r.value_bytes(t),i=e(t);return l.HEAPU8.subarray(i,i+u)}}(),r.value_bytes=function(){let n="sqlite3_value_bytes",e=l.cwrap(n,...a("n:n"));return function(t){return e(t)}}(),r.value_double=function(){let n="sqlite3_value_double",e=l.cwrap(n,...a("n:n"));return function(t){return e(t)}}(),r.value_int=function(){let n="sqlite3_value_int64",e=l.cwrap(n,...a("n:n"));return function(t){return e(t)}}(),r.value_int64=function(){let n="sqlite3_value_int64",e=l.cwrap(n,...a("n:n"));return function(t){let u=e(t),i=l.getTempRet0();return A(u,i)}}(),r.value_text=function(){let n="sqlite3_value_text",e=l.cwrap(n,...a("n:s"));return function(t){return e(t)}}(),r.value_type=function(){let n="sqlite3_value_type",e=l.cwrap(n,...a("n:n"));return function(t){return e(t)}}(),r.vfs_register=function(n,e){let t=l.registerVFS(n,e);return _("sqlite3_vfs_register",t)};function _(n,e,t=null,u=[I]){if(u.includes(e))return e;let i=t?l.ccall("sqlite3_errmsg","string",["number"],[t]):n;throw new q(i,e)}return r}function a(l){let r=[],o=l.match(/([ns@]*):([nsv@])/);switch(o[2]){case"n":r.push("number");break;case"s":r.push("string");break;case"v":r.push(null);break}let c=[];for(let p of o[1])switch(p){case"n":c.push("number");break;case"s":c.push("string");break}return r.push(c),r}async function D(l){let{fileName:r,sqlite:o}=await l,c=await o.open_v2(r);return{db:c,sqlite:o,async close(){await o.close(c)},changes(){return o.changes(c)},async lastInsertRowId(){return await new Promise(p=>o.exec(c,"SELECT last_insert_rowid()",([d])=>p(d)))},async run(p,d){let A=o.str_new(c,p),E=await o.prepare_v2(c,o.str_value(A));if(!E)return[];let y=E.stmt;try{d?.length&&o.bind_collection(y,d);let g=[],w=o.column_names(y);for(;await o.step(y)===N;){let f=o.row(y);g.push(Object.fromEntries(w.map((U,m)=>[U,f[m]])))}return g}finally{await o.finalize(y)}}}}function G(){return"getDirectory"in navigator?.storage}var T;async function j({fileName:l,preferOPFS:r,url:o}){let c;G()&&r?c=(await import("./opfs-GPKKYFU3-efdae2fd.js")).useOpfsStorage(l,{url:o}):c=(await import("./idb-R43MQZPM-4d6e83a9.js")).useIdbStorage(l,{url:o}),T=await D(c)}async function C({isSelect:l,sql:r,parameters:o}){let c=await T.run(r,o);if(l)return{rows:c};let p=BigInt(await T.lastInsertRowId()),d=BigInt(T.changes());return{rows:c,insertId:p,numAffectedRows:d}}onmessage=async l=>{let r=l.data,o={type:r.type,data:null,err:null};try{switch(r.type){case"init":await j(r);break;case"run":o.data=await C(r);break;case"close":await T.close();break}}catch(c){o.err=c}postMessage(o)};export{tn as $,X as G,K as J,$ as K,un as M,en as V,Q as W,W as X,Y,nn as Z,pn as a,cn as c,rn as d,on as e,wn as f,Z as j,ln as n,_n as o,sn as r,fn as s,an as t,bn as u,I as v,J as z};
